<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Group_ZF_3</title>
</head>


<body>
<div class="head">
<h1>Theory Group_ZF_3</h1>
</div>

<pre class="source"><span class="comment1">(* 
    This file is a part of IsarMathLib - 
    a library of formalized mathematics for Isabelle/Isar.

    Copyright (C) 2005, 2006  Slawomir Kolodynski

    This program is free software; Redistribution and use in source and binary forms, 
    with or without modification, are permitted provided that the following conditions are met:

   1. Redistributions of source code must retain the above copyright notice, 
   this list of conditions and the following disclaimer.
   2. Redistributions in binary form must reproduce the above copyright notice, 
   this list of conditions and the following disclaimer in the documentation and/or 
   other materials provided with the distribution.
   3. The name of the author may not be used to endorse or promote products 
   derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED 
WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES 
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, 
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, 
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; 
OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, 
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, 
EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Groups 3›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Group_ZF_3 <span class="keyword2"><span class="keyword">imports</span></span> <a href="Group_ZF_2.html">Group_ZF_2</a> <a href="Finite1.html">Finite1</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this theory we consider notions in group theory that are useful 
  for the construction of real numbers in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Real_ZF_x›</span></span></span></span> series of 
  theories.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Group valued finite range functions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section show that the group valued functions 
  $f : X\rightarrow G$, with the property that $f(X)$ is 
  a finite subset of $G$, is a group. Such functions play an important
  role in the construction of real numbers in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Real_ZF›</span></span></span></span> series.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following proves the essential condition to show that the set of 
  finite range functions is
  closed with respect to the lifted group operation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group0<span class="main">)</span> Group_ZF_3_1_L1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> 
  A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span>  FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword1"><span class="command">have</span></span> T1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">:</span><span class="free">X</span><span class="main">→</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">:</span><span class="free">X</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FinRangeFunctions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword1"><span class="command">have</span></span> T2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">:</span> <span class="free">X</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_2_L1 monoid0.Group_ZF_2_1_L0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">)</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Finite1_L18 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> A1 T1 T2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 
      group_oper_fun Finite1_L15 Group_ZF_2_1_L3 func_imagedef
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> FinRangeFunctions_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The set of group valued finite range functions is closed with respect 
  to the lifted group operation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group0<span class="main">)</span> Group_ZF_3_1_L2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="keyword1">{is</span> <span class="keyword1">closed</span> <span class="keyword1">under}</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> <span class="free">F</span><span class="main">`</span><span class="main">⟨</span> <span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">⟩</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_1_L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IsOpClosed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A composition of a finite range function with the group inverse is
  a finite range function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group0<span class="main">)</span> Group_ZF_3_1_L3<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">∈</span> FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groupAssum assms group0_2_T2 Finite1_L20 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The set of finite range functions is s subgroup of the lifted group.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Group_ZF_3_1_T1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span>FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">,</span><span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"TheNeutralElement<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"FinRangeFunctions<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> T1<span class="main">:</span> <span class="quoted"><span class="quoted">"group0<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> group0_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> T2<span class="main">:</span><span class="quoted"><span class="quoted">"group0<span class="main">(</span><span class="free">X</span><span class="main">→</span><span class="free">G</span><span class="main">,</span><span class="free">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0.Group_ZF_2_1_T2 group0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>   
    <span class="keyword1"><span class="command">from</span></span> T1 A3 <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"ConstantFunction<span class="main">(</span><span class="free">X</span><span class="main">,</span><span class="var">?e</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> group0.group0_2_L1 monoid0.unit_is_neutral
	Finite1_L17 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FinRangeFunctions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A2 T1 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="keyword1">{is</span> <span class="keyword1">closed</span> <span class="keyword1">under}</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0.Group_ZF_3_1_L2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 A2 T1 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> GroupInv<span class="main">(</span><span class="free">X</span><span class="main">→</span><span class="free">G</span><span class="main">,</span><span class="free">F</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FinRangeFunctions_def group0.Group_ZF_2_1_L6
      group0.Group_ZF_3_1_L3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> group0.group0_3_T3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Almost homomorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An almost homomorphism is a group valued function 
  defined on a monoid $M$ 
  with the property that the set $\{ f(m+n)-f(m)-f(n)\}_{m,n \in M}$ is finite.
  This term is used by R. D. Arthan in "The Eudoxus Real Numbers". We use this
  term in the general group context and use the A`Campo's term "slopes" 
  (see his "A natural construction for the real numbers") to mean
  an almost homomorphism mapping interegers into themselves. 
  We consider almost homomorphisms because we use slopes to 
  define real numbers in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Real_ZF_x›</span></span></span></span> series.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹HomDiff is an acronym for "homomorphism difference". 
  This is the expression
  $s(mn)(s(m)s(n))^{-1}$, or $s(m+n)-s(m)-s(n)$ in the additive notation.
  It is equal to the neutral element of the group if $s$ is a homomorphism.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HomDiff</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">≡</span> 
  <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">`</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="main">⟨</span> fst<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span>snd<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">,</span> 
  <span class="main">(</span>GroupInv<span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Almost homomorphisms are defined as those maps 
  $s:G\rightarrow G$ such that the 
  homomorphism difference takes only finite number of values on $G\times G$.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">AlmostHoms</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">≡</span> 
  <span class="main">{</span><span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">.</span><span class="main">{</span>HomDiff<span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">×</span><span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹AlHomOp1$(G,f)$ is the group operation on almost 
  homomorphisms defined in a natural way 
  by $(s\cdot r)(n) = s(n)\cdot r(n)$. In the terminology defined in 
  func1.thy this is the group operation $f$ (on $G$) 
  lifted to the function space $G\rightarrow G$ and restricted to the set 
  AlmostHoms$(G,f)$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">AlHomOp1</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">≡</span> 
  restrict<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span>
  AlmostHoms<span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">×</span>AlmostHoms<span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
 
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We also define a composition (binary) operator on almost homomorphisms in 
  a natural way. We call that operator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>AlHomOp2›</span></span></span></span> - the second operation 
  on almost homomorphisms. Composition of almost homomorphisms is 
  used to define multiplication of real numbers in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Real_ZF›</span></span></span></span> series.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">AlHomOp2</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">≡</span> 
  restrict<span class="main">(</span>Composition<span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">,</span>AlmostHoms<span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">×</span>AlmostHoms<span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This lemma provides more readable notation for the HomDiff
  definition. Not really intended to be used in proofs, but just to see the
  definition in the notation defined in the group0 locale.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group0<span class="main">)</span> HomDiff_notation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HomDiff<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">,</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main"><span class="free">⋅</span></span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HomDiff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The next lemma shows the set from the definition of almost 
  homomorphism in a different form.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group0<span class="main">)</span> Group_ZF_3_2_L1A<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>HomDiff<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">,</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">m</span><span class="main"><span class="free">⋅</span></span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="main">⟨</span> <span class="bound">m</span><span class="main">,</span><span class="bound">n</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span><span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> HomDiff<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">,</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="bound">m</span><span class="main">,</span><span class="bound">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">m</span><span class="main"><span class="free">⋅</span></span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> HomDiff_notation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ZF1_1_L4A<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Let's define some notation. We inherit the notation and assumptions 
  from the group0 context (locale) 
  and add some. We will use AH to denote the set of almost homomorphisms.
  $\sim$ is the inverse (negative if the group is the group of integers) of 
  almost homomorphisms, $(\sim p)(n)= p(n)^{-1}$.  
  $\delta $ will denote the homomorphism difference specific
  for the group (HomDiff$(G,f)$). The notation $s \approx r$ will mean that
  $s,r$ are almost equal, that is they are in the equivalence relation 
  defined by the group of finite range
  functions (that is a normal subgroup of almost homomorphisms, 
  if the group is abelian). We show that 
  this is equivalent to the set $\{ s(n)\cdot r(n)^{-1}: n\in G\}$ being
  finite.
  We also add an assumption that the
  $G$ is abelian as many needed properties do not hold without that.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> group1 <span class="main">=</span> group0 <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> isAbelian<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span> <span class="free">G</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AH</span> 
  <span class="keyword2"><span class="keyword">defines</span></span> AH_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="main">≡</span> AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Op1</span> 
  <span class="keyword2"><span class="keyword">defines</span></span> Op1_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Op1</span> <span class="main">≡</span> AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Op2</span>
  <span class="keyword2"><span class="keyword">defines</span></span> Op2_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Op2</span> <span class="main">≡</span> AlHomOp2<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">FR</span> 
  <span class="keyword2"><span class="keyword">defines</span></span> FR_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FR</span> <span class="main">≡</span> FinRangeFunctions<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">neg</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∼</span>_"</span> <span class="main">[</span>90<span class="main">]</span> 91<span class="main">)</span>
  <span class="keyword2"><span class="keyword">defines</span></span> neg_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∼</span></span><span class="free">s</span> <span class="main">≡</span> GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span>
  <span class="keyword2"><span class="keyword">defines</span></span> δ_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">≡</span> HomDiff<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">,</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AHprod</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∙</span>"</span> 69<span class="main">)</span>
  <span class="keyword2"><span class="keyword">defines</span></span> AHprod_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main"><span class="free">∙</span></span> <span class="free">r</span> <span class="main">≡</span>  AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">`</span><span class="main">⟨</span><span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AHcomp</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∘</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">defines</span></span> AHcomp_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main"><span class="free">∘</span></span> <span class="free">r</span> <span class="main">≡</span>  AlHomOp2<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">`</span><span class="main">⟨</span><span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AlEq</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 68<span class="main">)</span>
  <span class="keyword2"><span class="keyword">defines</span></span> AlEq_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main"><span class="free">≈</span></span> <span class="free">r</span> <span class="main">≡</span> <span class="main">⟨</span><span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹HomDiff is a homomorphism on the lifted group structure.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">:</span><span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">:</span><span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">F</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    D1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">⟨</span> <span class="skolem">m</span><span class="main">,</span><span class="skolem">n</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="free">G</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> T1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main"><span class="free">⋅</span></span><span class="skolem">n</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_2_L1 monoid0.group0_1_L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 D1 <span class="keyword1"><span class="command">have</span></span> T2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="skolem">m</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="skolem">m</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="skolem">m</span><span class="main"><span class="free">⋅</span></span><span class="skolem">n</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="skolem">m</span><span class="main"><span class="free">⋅</span></span><span class="skolem">n</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apply_funtype <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> A3 A1 <span class="keyword1"><span class="command">have</span></span> T3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">:</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_2_L1 monoid0.Group_ZF_2_1_L0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> D1 T3 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="var">?p</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="var">?p</span><span class="main">`</span><span class="main">(</span><span class="skolem">m</span><span class="main"><span class="free">⋅</span></span><span class="skolem">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="main">(</span><span class="var">?p</span><span class="main">`</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="var">?p</span><span class="main">`</span><span class="main">(</span><span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> HomDiff_notation apply_funtype group_inv_of_two 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A3 A1 D1 T1 isAbelian T2 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span> <span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_2_1_L3 group0_4_L3 HomDiff_notation
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The group operation lifted to the function space over $G$ preserves
  almost homomorphisms.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">:</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def group0_2_L1 monoid0.Group_ZF_2_1_L0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="var">?p</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span> <span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span> <span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> groupAssum A1 A2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IsAgroup_def IsAmonoid_def IsAssociative_def
      Finite1_L15 AlmostHoms_def Group_ZF_3_2_L1
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The set of almost homomorphisms is closed under the 
  lifted group operation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="keyword1">{is</span> <span class="keyword1">closed</span> <span class="keyword1">under}</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms IsOpClosed_def Group_ZF_3_2_L2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The terms in the homomorphism difference for a function
  are in the group.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">:</span><span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">∈</span><span class="free">G</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main"><span class="free">⋅</span></span><span class="free">n</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main"><span class="free">⋅</span></span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms group_op_closed inverse_in_group  
    apply_funtype HomDiff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It is handy to have a version of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span> Group_ZF_3_2_L4›</span></span></span></span>
  specifically for almost homomorphisms.›</span></span>
  
<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L4A<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">∈</span><span class="free">G</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main"><span class="free">⋅</span></span><span class="free">n</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main"><span class="free">⋅</span></span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms AlmostHoms_def Group_ZF_3_2_L4
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The terms in the homomorphism difference are in the group, 
  a different form.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L4B<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>snd<span class="main">(</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>snd<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?m</span><span class="main"><span class="free">⋅</span></span><span class="var">?n</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="var">?m</span><span class="main"><span class="free">⋅</span></span><span class="var">?n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="var">?m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="var">?n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="var">?m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="var">?n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L4A
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="var">?m</span><span class="main">,</span><span class="var">?n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L4A
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="var">?m</span><span class="main">,</span><span class="var">?n</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹What are the values of the inverse of an almost homomorphism?›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms AlmostHoms_def comp_fun_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Homomorphism difference commutes with the inverse for almost
  homomorphisms.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L6<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="var">?m</span><span class="main"><span class="free">⋅</span></span><span class="var">?n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="var">?m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="var">?n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> HomDiff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 isAbelian <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L4B HomDiff_def 
      Group_ZF_3_2_L5 group0_4_L4A
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The inverse of an almost homomorphism  maps the group into itself.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L7<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∼</span></span><span class="free">s</span> <span class="main">:</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groupAssum assms AlmostHoms_def group0_2_T2 comp_fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The inverse of an almost homomorphism is an almost homomorphism.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L8<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">,</span><span class="free">F</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> groupAssum  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">``</span><span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_2_T2 Finite1_L6A <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
     <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">``</span><span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> groupAssum <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">:</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> group0_2_T2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">.</span> <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L4B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> func1_1_L17 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A2 groupAssum A1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L7 AlmostHoms_def Group_ZF_2_1_L6
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The function that assigns the neutral element everywhere 
  is an almost homomorphism.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L9<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"ConstantFunction<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="main"><span class="free">𝟭</span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span><span class="main">≠</span><span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ConstantFunction<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="main"><span class="free">𝟭</span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> group0_2_L1 monoid0.group0_1_L3A
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">.</span> <span class="free">δ</span><span class="main">(</span><span class="var">?z</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="free">𝟭</span></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">×</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">⟨</span> <span class="skolem">m</span><span class="main">,</span><span class="skolem">n</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="var">?z</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="free">𝟭</span></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> group0_2_L1 monoid0.group0_1_L1
	func1_3_L2 HomDiff_def group0_2_L2 
	group_inv_of_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="var">?z</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main"><span class="free">𝟭</span></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ZF1_1_L5<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> group0_2_L2 Finite1_L16
    func1_3_L1 group0_2_L2 AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span><span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If the group is abelian, then almost homomorphisms form a 
  subgroup of the lifted group.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Group_ZF_3_2_L10<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span>AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">,</span><span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AH</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A2 A1 <span class="keyword1"><span class="command">have</span></span> T1<span class="main">:</span> <span class="quoted"><span class="quoted">"group1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group1_axioms.intro group0_def group1_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"group0<span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">,</span><span class="free">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_def group0.Group_ZF_2_1_T2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> T1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?AH</span><span class="main">≠</span><span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group1.Group_ZF_3_2_L9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> T2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?AH</span> <span class="main">⊆</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> T1 A3 <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?AH</span> <span class="keyword1">{is</span> <span class="keyword1">closed</span> <span class="keyword1">under}</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group1.Group_ZF_3_2_L3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> T1 A3 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="var">?AH</span><span class="main">.</span> GroupInv<span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">,</span><span class="free">F</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?AH</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group1.Group_ZF_3_2_L8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span>AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">,</span><span class="free">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0.group0_3_T3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If the group is abelian, then almost homomorphisms form a group
  with the first operation, hence we can use theorems proven in group0
  context aplied to this group.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L10A<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"group0<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> groupAssum isAbelian Group_ZF_3_2_L10 IsAsubgroup_def 
      AlHomOp1_def group0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The group of almost homomorphisms is abelian›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Group_ZF_3_2_L11<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span>AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span>AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span> <span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span> AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AH</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span><span class="var">?AH</span><span class="main">,</span><span class="var">?F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="var">?AH</span><span class="main">,</span>AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IsAsubgroup_def AlHomOp1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">:</span> <span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">)</span><span class="main">→</span><span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IsAgroup_def monoid0_def monoid0.Group_ZF_2_1_L0A
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?AH</span> <span class="main">⊆</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span> <span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_def group0.Group_ZF_2_1_L7
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span> <span class="var">?AH</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> func_ZF_4_L1 AlHomOp1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The first operation on homomorphisms acts in a natural way on its 
  operands.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L12<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∙</span></span><span class="free">r</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms AlHomOp1_def restrict AlmostHoms_def Group_ZF_2_1_L3
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹What is the group inverse in the group of almost homomorphisms?›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L13<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> groupAssum isAbelian <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="var">?F</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword3"><span class="command">show</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlHomOp1_def Group_ZF_2_1_L6A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L10A group0.inverse_in_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> I <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The group inverse in the group of almost homomorphisms acts in a 
  natural way on its operand.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L14<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> isAbelian assms Group_ZF_3_2_L13 AlmostHoms_def comp_fun_apply
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The next lemma states that if $s,r$ are almost homomorphisms, then
  $s\cdot r^{-1}$ is also an almost homomorphism.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Group_ZF_3_2_L15<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="main">=</span> AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Op1</span> <span class="main">=</span> AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Op1</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="quoted"><span class="quoted">"GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Op1</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span>GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms group0_def group1_axioms.intro group1_def
      group1.Group_ZF_3_2_L10A group0.group0_2_L1 
      monoid0.group0_1_L1 group0.inverse_in_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A version of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Group_ZF_3_2_L15›</span></span></span></span> formulated in notation
  used in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>group1›</span></span></span></span> context. States that the product of almost
  homomorphisms is an almost homomorphism and the the product
  of an almost homomorphism with a (pointwise) inverse of an almost 
  homomorphism is an almost homomorphism.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_2_L16<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">∙</span></span><span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">∙</span></span><span class="main">(</span><span class="main"><span class="free">∼</span></span><span class="free">r</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms isAbelian group0_def group1_axioms group1_def
  Group_ZF_3_2_L15 Group_ZF_3_2_L13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The classes of almost homomorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Real_ZF›</span></span></span></span> series we define real numbers as a quotient
  of the group of integer almost homomorphisms by the integer finite range
  functions. In this section we setup the background for that in the general
  group context.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Finite range functions are almost homomorphisms.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_3_L1<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">FR</span> <span class="main">⊆</span> <span class="free">AH</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> A1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">FR</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> T1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Finite1_L18 Finite1_L6B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">.</span> fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> group0_2_L1 monoid0.group0_1_L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> T1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Finite1_L6B<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="bound">g</span><span class="main"><span class="free">¯</span></span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inverse_in_group 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> T1 <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="skolem">s</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> group_oper_fun  Finite1_L15 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Finite1_L6C<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> HomDiff_def Finite1_L15  group_oper_fun 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> FinRangeFunctions_def AlmostHoms_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Finite range functions valued in an abelian group form a normal 
  subgroup of almost homomorphisms.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Group_ZF_3_3_L2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span><span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span>FinRangeFunctions<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">,</span>AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"IsAnormalSubgroup<span class="main">(</span>AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span>AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span>
  FinRangeFunctions<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?H1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?H2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"FinRangeFunctions<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">{lifted</span> <span class="keyword1">to</span> <span class="keyword1">function</span> <span class="keyword1">space</span> <span class="keyword1">over}</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> T1<span class="main">:</span><span class="quoted"><span class="quoted">"group0<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"monoid0<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"group1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_def group0.group0_2_L1  
      group1_axioms.intro group1_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">,</span><span class="var">?F</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span><span class="var">?H1</span><span class="main">,</span><span class="var">?F</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span><span class="var">?H2</span><span class="main">,</span><span class="var">?F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0.Group_ZF_2_1_T2 Group_ZF_3_2_L10
      monoid0.group0_1_L3A Group_ZF_3_1_T1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span><span class="var">?H1</span><span class="main">∩</span><span class="var">?H2</span><span class="main">,</span>restrict<span class="main">(</span><span class="var">?F</span><span class="main">,</span><span class="var">?H1</span><span class="main">×</span><span class="var">?H1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_3_L7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> T1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?H1</span><span class="main">∩</span><span class="var">?H2</span> <span class="main">=</span> <span class="var">?H2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group1.Group_ZF_3_3_L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IsAsubgroup<span class="main">(</span><span class="var">?H2</span><span class="main">,</span>AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlHomOp1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 A2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IsAnormalSubgroup<span class="main">(</span>AlmostHoms<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span>AlHomOp1<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">,</span>
    FinRangeFunctions<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L11 Group_ZF_2_4_L6
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The group of almost homomorphisms divided by the subgroup of finite
  range functions is an abelian group.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_3_T1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"IsAgroup<span class="main">(</span><span class="free">AH</span><span class="main">//</span>QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span><span class="main">,</span>QuotientGroupOp<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"QuotientGroupOp<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span> <span class="keyword1">{is</span> <span class="keyword1">commutative</span> <span class="keyword1">on}</span>
  <span class="main">(</span><span class="free">AH</span><span class="main">//</span>QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groupAssum isAbelian Group_ZF_3_3_L2 Group_ZF_3_2_L10A 
    Group_ZF_2_4_T1 Group_ZF_3_2_L10A Group_ZF_3_2_L11  
    Group_ZF_3_3_L2 IsAnormalSubgroup_def Group_ZF_2_4_L6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It is useful to have a direct statement that the 
  quotient group relation is an equivalence relation for the group of AH and
  subgroup FR.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_3_L3<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AH</span> <span class="main">×</span> <span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"equiv<span class="main">(</span><span class="free">AH</span><span class="main">,</span>QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groupAssum isAbelian QuotientGroupRel_def 
    Group_ZF_3_3_L2 Group_ZF_3_2_L10A group0.Group_ZF_2_4_L3 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The "almost equal" relation is symmetric.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_3_L3A<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">≈</span></span><span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="free">≈</span></span><span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_3_L3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">⟩</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equiv_is_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="free">≈</span></span><span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Although we have bypassed this fact when proving that 
  group of almost homomorphisms divided by the subgroup of finite
  range functions is a group, it is still useful to know directly 
  that the first group operation on AH is congruent with respect to the
  quotient group relation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_3_L4<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Congruent2<span class="main">(</span>QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groupAssum isAbelian Group_ZF_3_2_L10A Group_ZF_3_3_L2 
    Group_ZF_2_4_L5A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The class of an almost homomorphism $s$ is the neutral element
  of the quotient group of almost homomorphisms iff $s$ is a finite range
  function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_3_L5<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"TheNeutralElement<span class="main">(</span><span class="free">AH</span><span class="main">//</span><span class="free">r</span><span class="main">,</span>QuotientGroupOp<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">``</span><span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">=</span> <span class="free">e</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">FR</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> groupAssum isAbelian assms Group_ZF_3_2_L11 
    group0_def Group_ZF_3_3_L2 group0.Group_ZF_2_4_L5E
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The group inverse of a class of an almost homomorphism $f$
  is the class of the inverse of $f$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_3_L6<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> ProjFun2<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">r</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">``</span><span class="main">{</span><span class="main"><span class="free">∼</span></span><span class="free">s</span><span class="main">}</span> <span class="main">=</span> GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">//</span><span class="free">r</span><span class="main">,</span><span class="free">F</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">``</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> groupAssum isAbelian assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">``</span><span class="main">{</span>GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span> <span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">//</span><span class="free">r</span><span class="main">,</span><span class="free">F</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">r</span> <span class="main">``</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L10A Group_ZF_3_3_L2 QuotientGroupOp_def
      group0.Group_ZF_2_4_L7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L13
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Compositions of almost homomorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The goal of this section is to establish some facts about composition
  of almost homomorphisms. needed for the real numbers construction in 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Real_ZF_x›</span></span></span></span> series. In particular we show that the set of almost 
  homomorphisms is closed under composition and that composition
  is congruent with respect to the equivalence relation defined by the group
  of finite range functions (a normal subgroup of almost homomorphisms).›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The next formula restates the definition of the homomorphism 
  difference to express the value an almost homomorphism on a product.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">∈</span><span class="free">G</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main"><span class="free">⋅</span></span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> isAbelian assms Group_ZF_3_2_L4A HomDiff_def group0_4_L5
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹What is the value of a composition of almost homomorhisms?›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms AlmostHoms_def func_ZF_5_L3 restrict AlHomOp2_def
    apply_funtype <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹What is the homomorphism difference of a composition?›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">∈</span><span class="free">G</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> 
  <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> T1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span><span class="free">G</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L2 AlmostHoms_def apply_funtype 
      Group_ZF_3_2_L4A group0_2_L1 monoid0.group0_1_L1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> HomDiff_def group0_2_L1 monoid0.group0_1_L1 Group_ZF_3_4_L2
      Group_ZF_3_4_L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L4A Group_ZF_3_4_L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> T1 isAbelian <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
    <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
    <span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">=</span> 
    <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> group0_4_L6C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹What is the homomorphism difference of a composition (another form)?
  Here we split the homomorphism difference of a composition 
  into a product of three factors.
  This will help us in proving that the range of homomorphism difference
  for the composition is finite, as each factor has finite range.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span><span class="main"><span class="free">⋅</span></span><span class="free">B</span><span class="main"><span class="free">⋅</span></span><span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> A1
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="var">?m</span><span class="main">,</span><span class="var">?n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> 
    <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="var">?m</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="var">?n</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="var">?m</span><span class="main">,</span><span class="var">?n</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
    <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="var">?m</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="var">?n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">⟨</span> <span class="var">?m</span><span class="main">,</span><span class="var">?n</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Group_ZF_3_4_L3<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A1 A2 A3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The range of the homomorphism difference of a composition
  of two almost homomorphisms is finite. This is the essential condition
  to show that a composition of almost homomorphisms is an almost 
  homomorphism.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span>Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">.</span> <span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L4B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Finite1_L6B<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def apply_funtype <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Finite1_L6C<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group_oper_fun Finite1_L15 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">.</span>  <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">.</span> <span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L4B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Finite1_L6B<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
    <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group_oper_fun Finite1_L15 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">=</span> 
    <span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
    <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">r</span><span class="main">`</span><span class="main">(</span>snd<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> restrict AlHomOp2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Composition of almost homomorphisms is an almost homomorphism.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_T1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> <span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">:</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> func_ZF_5_L1 apply_funtype <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">`</span><span class="main">⟨</span> <span class="free">s</span><span class="main">,</span><span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L5 AlmostHoms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">∘</span></span><span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> AlHomOp2_def restrict 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The set of almost homomorphisms is closed under composition.
  The second operation on almost homomorphisms is associative.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L6<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="keyword1">{is</span> <span class="keyword1">closed</span> <span class="keyword1">under}</span> Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"AlHomOp2<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">{is</span> <span class="keyword1">associative</span> <span class="keyword1">on}</span> <span class="free">AH</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="keyword1">{is</span> <span class="keyword1">closed</span> <span class="keyword1">under}</span> Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_T1 IsOpClosed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="main">⊆</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="keyword1">{is</span> <span class="keyword1">associative</span> <span class="keyword1">on}</span> <span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> func_ZF_5_L5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"AlHomOp2<span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="keyword1">{is</span> <span class="keyword1">associative</span> <span class="keyword1">on}</span> <span class="free">AH</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> func_ZF_4_L3 AlHomOp2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Type information related to the situation of two almost
  homomorphisms.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L7<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">∈</span> <span class="free">G</span>"</span></span>   <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def apply_type  
      group0_2_L1 monoid0.group0_1_L1 inverse_in_group
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Type information related to the situation of three almost
  homomorphisms.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L8<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">∈</span> <span class="free">G</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def apply_type  
      group0_2_L1 monoid0.group0_1_L1 inverse_in_group
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A1 A2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">⟨</span> <span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">q</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def apply_type Group_ZF_3_2_L4A
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A formula useful in showing that the composition of almost
  homomorphisms is congruent with respect 
  to the quotient group relation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L9<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r2</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main"><span class="free">∘</span></span><span class="free">r1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="main">(</span><span class="free">s2</span><span class="main"><span class="free">∘</span></span><span class="free">r2</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">=</span>
  <span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span> <span class="main">(</span><span class="free">s2</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main"><span class="free">⋅</span></span><span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
  <span class="free">δ</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">,</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 isAbelian <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main"><span class="free">∘</span></span><span class="free">r1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="main">(</span><span class="free">s2</span><span class="main"><span class="free">∘</span></span><span class="free">r2</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">=</span>
    <span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">s2</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L2 Group_ZF_3_4_L7 group0_4_L6A
      group_oper_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main"><span class="free">∘</span></span><span class="free">r1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="main">(</span><span class="free">s2</span><span class="main"><span class="free">∘</span></span><span class="free">r2</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">=</span> <span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
    <span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">δ</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">,</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">⟩</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
    <span class="main">(</span><span class="free">s2</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L8 Group_ZF_3_4_L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 A2 isAbelian <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>
    Group_ZF_3_4_L8 group0_4_L7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The next lemma shows a formula that translates an expression
  in terms of the first group operation on almost homomorphisms and the
  group inverse in the group of almost homomorphisms to an expression using
  only the underlying group operations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L10<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∙</span></span><span class="main">(</span>GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> isAbelian Group_ZF_3_2_L13 Group_ZF_3_2_L12 Group_ZF_3_2_L14
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A neccessary condition for two a. h. to be almost equal.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L11<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">≈</span></span><span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> QuotientGroupRel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">s</span><span class="main"><span class="free">∙</span></span><span class="main">(</span>GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> QuotientGroupRel_def Finite1_L18 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A sufficient condition for two a. h. to be almost equal.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L12<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">≈</span></span><span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> groupAssum isAbelian A1 A2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L15 AlmostHoms_def 
    Group_ZF_3_4_L10 Finite1_L19 QuotientGroupRel_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Another sufficient consdition for two a.h. to be almost
  equal. It is actually just an expansion of the definition
  of the quotient group relation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L12A<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">AH</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span><span class="free">AH</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">∙</span></span><span class="main">(</span>GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">FR</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">≈</span></span><span class="free">r</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="free">≈</span></span><span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>  <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">≈</span></span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms QuotientGroupRel_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="free">≈</span></span><span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Group_ZF_3_3_L3A<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Another necessary condition for two a.h. to be almost
  equal. It is actually just an expansion of the definition
  of the quotient group relation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L12B<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">≈</span></span><span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main"><span class="free">∙</span></span><span class="main">(</span>GroupInv<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">FR</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms QuotientGroupRel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The next lemma states the essential condition for 
  the composition of a. h. to be congruent
  with respect to the quotient group relation for the subgroup of finite 
  range functions.›</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L13<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span><span class="main"><span class="free">≈</span></span><span class="free">s2</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r1</span><span class="main"><span class="free">≈</span></span><span class="free">r2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main"><span class="free">∘</span></span><span class="free">r1</span><span class="main">)</span> <span class="main"><span class="free">≈</span></span> <span class="main">(</span><span class="free">s2</span><span class="main"><span class="free">∘</span></span><span class="free">r2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span> <span class="main">(</span><span class="free">s2</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> QuotientGroupRel_def AlmostHoms_def apply_funtype
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">s2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Finite1_L6B<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">∈</span><span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> QuotientGroupRel_def AlmostHoms_def apply_funtype
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Finite1_L6C<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span> <span class="main">(</span><span class="free">s2</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main"><span class="free">⋅</span></span><span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span><span class="main">.</span> 
    <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group_oper_fun Finite1_L15 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">,</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">⟩</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="main">⟨</span> <span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">,</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> QuotientGroupRel_def Group_ZF_3_4_L7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> QuotientGroupRel_def AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Finite1_L6B<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span> <span class="main">(</span><span class="free">s2</span><span class="main">`</span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main"><span class="free">⋅</span></span><span class="free">s1</span><span class="main">`</span><span class="main">(</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">)</span><span class="main"><span class="free">⋅</span></span>
    <span class="free">δ</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span><span class="main">⟨</span> <span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">,</span><span class="free">r1</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r2</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">⟩</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group_oper_fun Finite1_L15 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>
    QuotientGroupRel_def Group_ZF_3_4_L9 
    Group_ZF_3_4_T1 Group_ZF_3_4_L12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Composition of a. h. to is congruent
  with respect to the quotient group relation for the subgroup of finite 
  range functions. Recall that if an operation say "$\circ $" on $X$ is 
  congruent with respect to an equivalence relation $R$ then we can 
  define the operation 
  on the quotient space $X/R$ by $[s]_R\circ [r]_R := [s\circ r]_R$ and this
  definition will be correct i.e. it will not depend on the choice of 
  representants for the classes $[x]$ and $[y]$. This is why we want it here.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L13A<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"Congruent2<span class="main">(</span>QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L13 Congruent2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The homomorphism difference for the identity function is equal to
  the neutral element of the group (denoted $e$ in the group1 context).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L14<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span><span class="main">(</span>id<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="free">𝟭</span></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>
    group0_2_L1 monoid0.group0_1_L1 HomDiff_def id_conv group0_2_L6
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The identity function ($I(x) = x$) on $G$ is an almost homomorphism.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L15<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main">×</span><span class="free">G</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> group0_2_L1 monoid0.group0_1_L3A 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L14 group0_2_L2
    id_type AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Almost homomorphisms form a monoid with composition.
  The identity function on the group is the neutral element there.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_L16<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"IsAmonoid<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"monoid0<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span> TheNeutralElement<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"TheNeutralElement<span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">,</span>Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"IsAmonoid<span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">,</span>Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"monoid0<span class="main">(</span><span class="free">G</span><span class="main">→</span><span class="free">G</span><span class="main">,</span>Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> monoid0_def Group_ZF_2_5_L2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="keyword1">{is</span> <span class="keyword1">closed</span> <span class="keyword1">under}</span> Composition<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_4_L6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">AH</span> <span class="main">⊆</span> <span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_2_5_L2 Group_ZF_3_4_L15 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span>  <span class="var">?i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_2_5_L2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"IsAmonoid<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"monoid0<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span> TheNeutralElement<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> monoid0.group0_1_T1 group0_1_L6 AlHomOp2_def monoid0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We can project the monoid of almost homomorphisms with composition
  to the group of almost homomorphisms divided by the subgroup of finite
  range functions. The class of the identity function is the neutral element
  of the quotient (monoid).›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_4_T2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> QuotientGroupRel<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">,</span><span class="free">FR</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"IsAmonoid<span class="main">(</span><span class="free">AH</span><span class="main">//</span><span class="free">R</span><span class="main">,</span>ProjFun2<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">R</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">``</span><span class="main">{</span>id<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> TheNeutralElement<span class="main">(</span><span class="free">AH</span><span class="main">//</span><span class="free">R</span><span class="main">,</span>ProjFun2<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">R</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"group0<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">Op1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_2_L10A group0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A1 groupAssum isAbelian <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"IsAmonoid<span class="main">(</span><span class="free">AH</span><span class="main">//</span><span class="free">R</span><span class="main">,</span>ProjFun2<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">R</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">``</span><span class="main">{</span>id<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> TheNeutralElement<span class="main">(</span><span class="free">AH</span><span class="main">//</span><span class="free">R</span><span class="main">,</span>ProjFun2<span class="main">(</span><span class="free">AH</span><span class="main">,</span><span class="free">R</span><span class="main">,</span><span class="free">Op2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group_ZF_3_3_L2 group0.Group_ZF_2_4_L3 Group_ZF_3_4_L13A 
      Group_ZF_3_4_L16 monoid0.Group_ZF_2_2_T1 Group_ZF_2_2_L1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Shifting almost homomorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this this section we consider what happens if we multiply
  an almost homomorphism by a group element. We show that the
  resulting function is also an a. h., and almost equal to the original
  one. This is used only for slopes (integer a.h.) in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Int_ZF_2›</span></span></span></span>
  where we need to correct a positive slopes by adding a constant, so that
  it is at least $2$ on positive integers.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If $s$ is an almost homomorphism and $c$ is some constant from the group, 
  then $s\cdot c$ is an almost homomorphism.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group1<span class="main">)</span> Group_ZF_3_5_L1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">x</span><span class="main">,</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">c</span><span class="main">⟩</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main"><span class="free">≈</span></span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A2 A3 <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">:</span><span class="free">G</span><span class="main">→</span><span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def apply_funtype group_op_closed 
    ZF_fun_from_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A3 <span class="keyword3"><span class="command">show</span></span> II<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ZF_fun_from_tot_val <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> isAbelian A1 A2 <span class="keyword1"><span class="command">have</span></span> III<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">.</span> <span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">c</span><span class="main"><span class="free">¯</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group_op_closed AlmostHoms_def apply_funtype
    HomDiff_def group0_4_L7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A1 A2 <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>   <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main"><span class="free">¯</span></span><span class="main">∈</span><span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def inverse_in_group <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">c</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> Fin<span class="main">(</span><span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> group_oper_fun Finite1_L16AA
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> III <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">δ</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="free">c</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ZF1_1_L4B<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> I <span class="keyword3"><span class="command">show</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">AH</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> isAbelian A1 A2 I II <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="free">G</span><span class="main">.</span> <span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span> <span class="main">=</span> <span class="free">c</span><span class="main"><span class="free">¯</span></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AlmostHoms_def apply_funtype group0_4_L6AB
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main"><span class="free">⋅</span></span><span class="main">(</span><span class="free">r</span><span class="main">`</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">c</span><span class="main"><span class="free">¯</span></span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="free">G</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ZF1_1_L4B<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A1 A2 IV <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main"><span class="free">≈</span></span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> group0_2_L1 monoid0.group0_1_L3A 
      inverse_in_group Group_ZF_3_4_L12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>